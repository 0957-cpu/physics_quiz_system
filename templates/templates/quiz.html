{% extends "base.html" %}
{% block content %}

  <h2>ğŸ“˜ ç‰©ç†é¡Œåº«æŒ‘æˆ°</h2>
  <p>æ­¡è¿ï¼Œ{{ name }}ï¼è«‹é–‹å§‹ä½œç­”ï¼š</p>

  {# ===========================
     A. å›ºå®šåœ¨ä¸Šæ–¹çš„å€’æ•¸è¨ˆæ™‚æ¢
     ============================ #}
  {% if time_limit_seconds and time_limit_seconds > 0 %}
    <div id="timer_bar"
         style="
           position: sticky;
           top: 0;
           z-index: 999;
           background-color: #f9f9f9;
           padding: 8px 12px;
           margin: 8px 0 12px 0;
           border: 2px solid #ccc;
           border-radius: 6px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         ">
      â³ å‰©é¤˜æ™‚é–“ï¼š
      <span id="timer_display" style="font-size: 1.2em; font-weight: bold;">--:--</span>
    </div>
  {% endif %}

  <form id="quiz_form" method="post" action="{{ url_for('submit') }}">
    {% for q in quiz %}
      <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
        <b>{{ loop.index }}. {{ q.text }}</b><br><br>
        {% if q.options %}
          {% for opt in q.options %}
            <label>
              <input type="radio" name="{{ q.id }}" value="{{ opt }}" required>
              {{ opt }}
            </label><br>
          {% endfor %}
        {% else %}
          <p style="color:red;">âš ï¸ æ­¤é¡Œæ²’æœ‰é¸é …ï¼Œè«‹æª¢æŸ¥é¡Œåº«ã€‚</p>
        {% endif %}
      </div>
    {% endfor %}
    <button type="submit" style="padding: 8px 16px;">é€å‡ºç­”æ¡ˆ</button>
  </form>

  {% if time_limit_seconds and time_limit_seconds > 0 %}
  <style>
    /* å‰© 1 åˆ†é˜æ™‚ï¼Œç´…è‰²é–ƒçˆ */
    @keyframes flashRed {
      0%   { color: #ff0000; }
      50%  { color: #ffaaaa; }
      100% { color: #ff0000; }
    }
    .timer-urgent {
      animation: flashRed 1s infinite;
      font-weight: bold;
    }
  </style>

  <script>
  (function() {
      // å¾å¾Œç«¯æ‹¿åˆ°çš„ç¸½ç§’æ•¸ï¼ˆæ•´ä»½è€ƒå·çš„é™æ™‚ï¼‰
      var originalTotalSeconds = {{ time_limit_seconds|int }};
      var display = document.getElementById('timer_display');
      var form = document.getElementById('quiz_form');
      var timerBar = document.getElementById('timer_bar');
      var STORAGE_KEY = "quiz_end_time";  // ç”¨ä¾†é¿å…é‡æ•´ä½œå¼Š

      if (!display || !form) {
        return;  // é˜²å‘†ï¼šå¦‚æœç•«é¢ä¸Šæ²’æœ‰é€™äº›å…ƒç´ å°±ä¸è·‘
      }

      // ç›£è½è¡¨å–®é€å‡ºï¼šä¸ç®¡æ˜¯æ™‚é–“åˆ°è‡ªå‹•é€å‡ºæˆ–å­¸ç”Ÿè‡ªå·±æŒ‰é€å‡ºï¼Œéƒ½æ¸…æ‰ localStorage
      form.addEventListener("submit", function() {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {}
      });

      // ä½¿ç”¨ localStorage å­˜ã€ŒçµæŸæ™‚é–“ã€ï¼Œé¿å…æŒ‰ F5 é‡ä¾†
      var endTime = null;
      try {
        var storedEnd = localStorage.getItem(STORAGE_KEY);
        if (storedEnd) {
          endTime = parseInt(storedEnd, 10);
        }
      } catch (e) {
        endTime = null;
      }

      // å¦‚æœ localStorage æ²’æœ‰è¨˜éŒ„ï¼Œå°±å¾ç¾åœ¨é–‹å§‹è¨ˆ originalTotalSeconds ç§’
      if (!endTime || isNaN(endTime)) {
        endTime = Date.now() + originalTotalSeconds * 1000;
        try {
          localStorage.setItem(STORAGE_KEY, String(endTime));
        } catch (e) {}
      }

      // æ ¼å¼åŒ– mm:ss
      function formatTime(sec) {
        var m = Math.floor(sec / 60);
        var s = sec % 60;
        return m.toString().padStart(2, '0') + ":" + s.toString().padStart(2, '0');
      }

      function tick() {
        var now = Date.now();
        var diffMs = endTime - now;
        var totalSeconds = Math.floor(diffMs / 1000);

        // æ™‚é–“åˆ°äº†æˆ–è¶…éäº†ï¼šå¼·åˆ¶äº¤å·
        if (totalSeconds <= 0) {
          display.textContent = "00:00";
          display.style.color = "red";
          display.style.fontWeight = "bold";
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {}
          alert("æ™‚é–“åˆ°ï¼ç³»çµ±å°‡è‡ªå‹•é€å‡ºç­”æ¡ˆä¸¦è¨ˆåˆ†ã€‚");
          form.submit();
          return;
        }

        // å‰© 3 åˆ†é˜ä»¥å…§ï¼šç´…è‰²æé†’
        if (totalSeconds <= 180) {
          display.style.color = "red";
          display.style.fontWeight = "bold";
        }

        // å‰© 1 åˆ†é˜ä»¥å…§ï¼šç´…è‰²é–ƒçˆ
        if (totalSeconds <= 60) {
          display.classList.add("timer-urgent");
        }

        display.textContent = formatTime(totalSeconds);

        // æ¯ç§’è·‘ä¸€æ¬¡
        setTimeout(tick, 1000);
      }

      // åˆå§‹åŒ–é¡¯ç¤º
      var initSeconds = Math.floor((endTime - Date.now()) / 1000);
      if (initSeconds <= 0) {
        // å‰›è¼‰å…¥å°±å·²ç¶“è¶…æ™‚
        display.textContent = "00:00";
        display.style.color = "red";
        display.style.fontWeight = "bold";
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {}
        alert("ä½œç­”æ™‚é–“å·²çµæŸï¼Œç³»çµ±å°‡è‡ªå‹•é€å‡ºç­”æ¡ˆä¸¦è¨ˆåˆ†ã€‚");
        form.submit();
        return;
      } else {
        display.textContent = formatTime(initSeconds);
        setTimeout(tick, 1000);
      }

      // è¦–çª—åˆ‡æ›æé†’ï¼ˆé˜²ç¯„åˆ‡å‡ºå»åšåˆ¥çš„äº‹ï¼‰
      var blurWarned = false;
      document.addEventListener("visibilitychange", function() {
        if (document.hidden && !blurWarned) {
          alert("è«‹ä¿æŒåœ¨æ¸¬é©—ç•«é¢ï¼Œé¿å…å½±éŸ¿ä½œç­”èˆ‡ç´€éŒ„ã€‚");
          blurWarned = true;
        }
      });

  })();
  </script>
  {% endif %}

{% endblock %}
